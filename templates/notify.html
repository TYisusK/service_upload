<!-- OneSignal SDK v16 -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<script>
  const params  = new URLSearchParams(location.search);
  const session = params.get("session") || "";
  const out     = document.getElementById("out");
  const btn     = document.getElementById("btn");

  // evita re-inicializar si el usuario vuelve a hacer clic
  window.__onesignal_init = window.__onesignal_init || false;

  // helper: avisar al backend que quedó listo
  function tellOk() {
    if (!session) return;
    fetch(`/notify/ok?session=${encodeURIComponent(session)}`, { method: "POST" }).catch(()=>{});
  }

  // registra el SW desde la raíz (asegúrate de que el backend sirva /OneSignalSDKWorker.js)
  async function registerSW() {
    if (!("serviceWorker" in navigator)) return;
    try {
      const regs = await navigator.serviceWorker.getRegistrations();
      // si ya hay uno de OneSignal, úsalo; si no, regístralo
      const hasOSW = regs.some(r => r.active && /OneSignalSDK/i.test(r.active.scriptURL));
      if (!hasOSW) {
        await navigator.serviceWorker.register("/OneSignalSDKWorker.js", { scope: "/" });
      }
    } catch (e) {
      console.warn("SW register warn:", e);
    }
  }

  btn.addEventListener("click", () => {
    out.textContent = "Inicializando OneSignal…";

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function(OneSignal) {
      try {
        if (!window.__onesignal_init) {
          await registerSW();

          await OneSignal.init({
            appId: "{{ onesignal_app_id }}",
            // Si usas un sub-path, ajusta:
            // serviceWorkerParam: { path: "/OneSignalSDKWorker.js", scope: "/" }
          });

          window.__onesignal_init = true;
        }

        // pedir permiso (esto NO toca User.PushSubscription)
        const perm = await OneSignal.Notifications.requestPermission();
        if (perm === "granted") {
          out.innerHTML = "✅ Notificaciones activadas. Puedes cerrar esta pestaña.";
          tellOk();
          return;
        }
        if (perm === "denied") {
          out.innerHTML = "❗ Has bloqueado las notificaciones en el navegador. Habilítalas en los permisos del sitio y vuelve a intentar.";
          return;
        }
        // "default" (ni aceptó ni negó)
        out.innerHTML = "ℹ️ No se otorgó permiso. Puedes intentarlo de nuevo.";
      } catch (e) {
        // cuando se clickea dos veces suele lanzar “initAlreadyCalled”
        const msg = (e && (e.message || e.toString())) || "Error";
        if (/already/i.test(msg)) {
          out.textContent = "SDK ya inicializado. Intentando pedir permiso…";
          try {
            const perm = await OneSignal.Notifications.requestPermission();
            if (perm === "granted") {
              out.innerHTML = "✅ Notificaciones activadas. Puedes cerrar esta pestaña.";
              tellOk();
              return;
            }
            out.innerHTML = "ℹ️ No se otorgó permiso. Puedes intentarlo de nuevo.";
            return;
          } catch (e2) {
            out.innerHTML = "Error: " + (e2.message || e2.toString());
            return;
          }
        }
        out.innerHTML = "Error: " + msg;
      }
    });
  });
</script>
